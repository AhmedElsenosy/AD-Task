<?xml version="1.0" encoding="UTF-8"?>
<configuration>
    <system.webServer>
        <!-- Compression -->
        <httpCompression directory="%SystemDrive%\inetpub\temp\IIS Temporary Compressed Files">
            <scheme name="gzip" dll="%Windir%\system32\inetsrv\gzip.dll" staticCompressionLevel="9" />
            <dynamicTypes>
                <add mimeType="text/html" enabled="true" />
                <add mimeType="text/plain" enabled="true" />
                <add mimeType="text/xml" enabled="true" />
                <add mimeType="text/css" enabled="true" />
                <add mimeType="text/javascript" enabled="true" />
                <add mimeType="application/javascript" enabled="true" />
                <add mimeType="application/json" enabled="true" />
            </dynamicTypes>
        </httpCompression>

        <!-- URL Rewrite Rules -->
        <rewrite>
            <rules>
                <!-- Enforce HTTPS (comment out if not using SSL) -->
                <rule name="HTTP to HTTPS Redirect" stopProcessing="true">
                    <match url="(.*)" />
                    <conditions>
                        <add input="{HTTPS}" pattern="^OFF$" />
                    </conditions>
                    <action type="Redirect" url="https://{HTTP_HOST}{REQUEST_URI}" redirectType="Permanent" />
                </rule>

                <!-- Remove www from domain (optional) -->
                <rule name="Remove WWW" stopProcessing="true">
                    <match url="^(.*)$" />
                    <conditions>
                        <add input="{HTTP_HOST}" pattern="^www\.(.+)$" />
                    </conditions>
                    <action type="Redirect" url="http://{C:1}{REQUEST_URI}" redirectType="Permanent" />
                </rule>

                <!-- Proxy requests to Gunicorn -->
                <rule name="ReverseProxyToGunicorn" stopProcessing="true">
                    <match url="^(.*)$" />
                    <conditions>
                        <add input="{REQUEST_FILENAME}" matchType="IsFile" negate="true" />
                        <add input="{REQUEST_FILENAME}" matchType="IsDirectory" negate="true" />
                    </conditions>
                    <action type="Rewrite" url="http://127.0.0.1:8000/{R:1}" />
                </rule>
            </rules>

            <!-- Proxy rules for Gunicorn -->
            <outboundRules>
                <rule name="ReverseProxyOutboundRule1" preCondition="ResponseIsHtml">
                    <match filterByTags="A, Form, Img" pattern="^http://127\.0\.0\.1:8000/(.*)" />
                    <action type="Rewrite" value="/{R:1}" />
                </rule>
                <preConditions>
                    <preCondition name="ResponseIsHtml">
                        <add input="{RESPONSE_CONTENT_TYPE}" pattern="^text/html" />
                    </preCondition>
                </preConditions>
            </outboundRules>
        </rewrite>

        <!-- Static Files Handler -->
        <staticContent>
            <mimeMap fileExtension=".json" mimeType="application/json" />
            <mimeMap fileExtension=".woff" mimeType="font/woff" />
            <mimeMap fileExtension=".woff2" mimeType="font/woff2" />
            <mimeMap fileExtension=".ttf" mimeType="font/ttf" />
            <mimeMap fileExtension=".eot" mimeType="application/vnd.ms-fontobject" />
        </staticContent>

        <!-- Remove unnecessary headers for security -->
        <httpProtocol>
            <customHeaders>
                <remove name="X-Powered-By" />
            </customHeaders>
        </httpProtocol>

        <!-- Request Filtering -->
        <security>
            <requestFiltering>
                <!-- Limit request size to 50MB -->
                <requestLimits maxAllowedContentLength="52428800" />
                
                <!-- Block dangerous file types -->
                <fileExtensions>
                    <add fileExtension=".exe" allowed="false" />
                    <add fileExtension=".bat" allowed="false" />
                    <add fileExtension=".cmd" allowed="false" />
                    <add fileExtension=".com" allowed="false" />
                    <add fileExtension=".pdb" allowed="false" />
                </fileExtensions>
            </requestFiltering>
        </security>

        <!-- Disable directory listing -->
        <directoryBrowse enabled="false" />

        <!-- Performance tuning -->
        <system.webServer>
            <serverRuntime frequentistTimeout="00:00:30" appConcurrentRequestLimit="unlimited" />
        </system.webServer>
    </system.webServer>

    <!-- Application pool settings -->
    <system.applicationHost>
        <applicationPool>
            <add name="AD-Task" autoStart="true" managedRuntimeVersion="No Managed Code" />
        </applicationPool>
    </system.applicationHost>

    <appSettings>
        <!-- Django settings -->
        <add key="DEBUG" value="False" />
        <add key="DJANGO_SETTINGS_MODULE" value="core.settings" />
    </appSettings>
</configuration>
